#!/bin/bash

# Script to automatically manage monitor configuration on Hyprland
# Priority: external monitor when connected, laptop only when it's the only one

# ============ CONFIGURATION ============
# Read configuration from monitors.conf
CONFIG_FILE="$HOME/.config/hypr/monitors.conf"

# Extract values from monitors.conf
if [ -f "$CONFIG_FILE" ]; then
    LAPTOP_MONITOR=$(grep "^env = LAPTOP_MONITOR" "$CONFIG_FILE" | cut -d',' -f2 | tr -d ' ')
    LAPTOP_POSITION=$(grep "^env = LAPTOP_POSITION" "$CONFIG_FILE" | cut -d',' -f2 | tr -d ' ')
fi

# Fallback to defaults if not found
LAPTOP_MONITOR="${LAPTOP_MONITOR:-eDP-1}"
LAPTOP_POSITION="${LAPTOP_POSITION:-right}"
# =======================================

# State file to track previous monitor configuration
STATE_FILE="/tmp/hypr_monitor_state"
PREVIOUS_EXTERNAL_COUNT=0
if [ -f "$STATE_FILE" ]; then
    PREVIOUS_EXTERNAL_COUNT=$(cat "$STATE_FILE")
fi

# Get list of all active monitors
ALL_MONITORS=$(hyprctl monitors -j | jq -r '.[].name')
EXTERNAL_MONITORS=$(echo "$ALL_MONITORS" | grep -v "$LAPTOP_MONITOR")

# Count external monitors
EXTERNAL_COUNT=$(echo "$EXTERNAL_MONITORS" | grep -v '^$' | wc -l)

# Check if laptop screen exists
LAPTOP_EXISTS=$(echo "$ALL_MONITORS" | grep -c "$LAPTOP_MONITOR")

# Determine primary monitor
if [ "$EXTERNAL_COUNT" -gt 0 ]; then
    # Sort external monitors numerically to get the first one in order
    PRIMARY_MONITOR=$(echo "$EXTERNAL_MONITORS" | sort -V | head -n1)

    # If laptop exists, it becomes secondary; otherwise no secondary monitor
    if [ "$LAPTOP_EXISTS" -gt 0 ]; then
        SECONDARY_MONITOR="$LAPTOP_MONITOR"
    else
        SECONDARY_MONITOR=""
    fi

    # Show notification only when connecting external monitor (transition from 0 to 1+)
    if [ "$PREVIOUS_EXTERNAL_COUNT" -eq 0 ]; then
        notify-send "Monitor Setup" "External monitor detected: $PRIMARY_MONITOR set as primary" -t 3000
    fi
else
    PRIMARY_MONITOR="$LAPTOP_MONITOR"
    SECONDARY_MONITOR=""
    # Show notification only when disconnecting external monitors (transition from 1+ to 0)
    if [ "$PREVIOUS_EXTERNAL_COUNT" -gt 0 ]; then
        notify-send "Monitor Setup" "All workspaces moved to laptop screen" -t 3000
    fi
fi

# Save current state for next run
echo "$EXTERNAL_COUNT" > "$STATE_FILE"

# Get number of workspaces configured in Hyprland
# Check for workspace configuration in hyprland.conf
HYPRLAND_CONF="$HOME/.config/hypr/hyprland.conf"
NUM_WORKSPACES=10  # Default fallback

if [ -f "$HYPRLAND_CONF" ]; then
    # Try to find workspace bindings to determine how many workspaces are configured
    MAX_WORKSPACE=$(grep -oP 'workspace\s*=?\s*\K\d+' "$HYPRLAND_CONF" 2>/dev/null | sort -n | tail -1)
    if [ -n "$MAX_WORKSPACE" ] && [ "$MAX_WORKSPACE" -gt 0 ]; then
        NUM_WORKSPACES="$MAX_WORKSPACE"
    fi
fi

# Configure primary monitor at position 0,0
hyprctl keyword monitor "$PRIMARY_MONITOR,preferred,0x0,1" > /dev/null 2>&1

# Bind workspaces 1-NUM_WORKSPACES to primary monitor only
for i in $(seq 1 "$NUM_WORKSPACES"); do
    hyprctl keyword workspace "$i,monitor:$PRIMARY_MONITOR,default:true" > /dev/null 2>&1
done

# Get all existing workspaces
EXISTING_WORKSPACES=$(hyprctl workspaces -j | jq -r '.[].id' | sort -n)

# Move ALL workspaces (including those beyond NUM_WORKSPACES) to primary monitor first
for workspace in $EXISTING_WORKSPACES; do
    hyprctl dispatch moveworkspacetomonitor "$workspace $PRIMARY_MONITOR" > /dev/null 2>&1
done

# Configure secondary monitor (laptop when external is connected)
if [ -n "$SECONDARY_MONITOR" ] && [ "$LAPTOP_EXISTS" -gt 0 ]; then
    case "$LAPTOP_POSITION" in
        "right")
            hyprctl keyword monitor "$SECONDARY_MONITOR,preferred,1920x0,1" > /dev/null 2>&1
            ;;
        "left")
            hyprctl keyword monitor "$PRIMARY_MONITOR,preferred,1920x0,1" > /dev/null 2>&1
            hyprctl keyword monitor "$SECONDARY_MONITOR,preferred,0x0,1" > /dev/null 2>&1
            ;;
        "above")
            hyprctl keyword monitor "$SECONDARY_MONITOR,preferred,0x-1080,1" > /dev/null 2>&1
            ;;
        "below")
            hyprctl keyword monitor "$SECONDARY_MONITOR,preferred,0x1080,1" > /dev/null 2>&1
            ;;
        "disable")
            hyprctl keyword monitor "$SECONDARY_MONITOR,disable" > /dev/null 2>&1
            ;;
        *)
            hyprctl keyword monitor "$SECONDARY_MONITOR,preferred,1920x0,1" > /dev/null 2>&1
            ;;
    esac

    # Create a fixed workspace for secondary monitor (NUM_WORKSPACES + 1)
    SECONDARY_WORKSPACE=$((NUM_WORKSPACES + 1))
    hyprctl keyword workspace "$SECONDARY_WORKSPACE,monitor:$SECONDARY_MONITOR,default:true" > /dev/null 2>&1

    # Check if the secondary workspace already exists and has windows
    SECONDARY_WS_EXISTS=$(echo "$EXISTING_WORKSPACES" | grep -c "^$SECONDARY_WORKSPACE$")
    if [ "$SECONDARY_WS_EXISTS" -eq 0 ]; then
        # Create it only if it doesn't exist
        hyprctl dispatch workspace "$SECONDARY_WORKSPACE" > /dev/null 2>&1
    fi

    # Move it to secondary monitor
    hyprctl dispatch moveworkspacetomonitor "$SECONDARY_WORKSPACE $SECONDARY_MONITOR" > /dev/null 2>&1
else
    # When no external monitor, clean up extra workspaces that are empty
    SECONDARY_WORKSPACE=$((NUM_WORKSPACES + 1))

    # Check all workspaces beyond NUM_WORKSPACES
    for workspace in $EXISTING_WORKSPACES; do
        if [ "$workspace" -gt "$NUM_WORKSPACES" ]; then
            # Check if workspace has windows
            WINDOW_COUNT=$(hyprctl workspaces -j | jq -r ".[] | select(.id == $workspace) | .windows")
            if [ "$WINDOW_COUNT" -eq 0 ]; then
                # Remove empty workspace by switching away and letting Hyprland clean it up
                hyprctl dispatch workspace 1 > /dev/null 2>&1
            fi
        fi
    done
fi

# Configure additional external monitors if present
if [ "$EXTERNAL_COUNT" -gt 1 ]; then
    OFFSET=1920
    # If laptop exists, secondary workspaces start from NUM_WORKSPACES + 2
    # If laptop doesn't exist, secondary workspaces start from NUM_WORKSPACES + 1
    if [ "$LAPTOP_EXISTS" -gt 0 ]; then
        WORKSPACE_NUM=$((NUM_WORKSPACES + 2))
    else
        WORKSPACE_NUM=$((NUM_WORKSPACES + 1))
    fi

    # Sort external monitors numerically and skip the first one (already configured as primary)
    for monitor in $(echo "$EXTERNAL_MONITORS" | sort -V | tail -n +2); do
        if [ -n "$monitor" ]; then
            OFFSET=$((OFFSET + 1920))
            hyprctl keyword monitor "$monitor,preferred,${OFFSET}x0,1" > /dev/null 2>&1

            # Create fixed workspace for this monitor
            hyprctl keyword workspace "$WORKSPACE_NUM,monitor:$monitor,default:true" > /dev/null 2>&1

            # Check if workspace already exists
            WS_EXISTS=$(echo "$EXISTING_WORKSPACES" | grep -c "^$WORKSPACE_NUM$")
            if [ "$WS_EXISTS" -eq 0 ]; then
                hyprctl dispatch workspace "$WORKSPACE_NUM" > /dev/null 2>&1
            fi

            hyprctl dispatch moveworkspacetomonitor "$WORKSPACE_NUM $monitor" > /dev/null 2>&1

            WORKSPACE_NUM=$((WORKSPACE_NUM + 1))
        fi
    done
fi

# Switch to workspace 1 on primary monitor
hyprctl dispatch workspace 1 > /dev/null 2>&1