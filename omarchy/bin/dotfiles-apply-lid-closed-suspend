#!/bin/bash

# Configures lid-closed suspend with USB wake support
# BIOS: Set Sleep State=Linux, USB Wake Support=Enabled
# Requires reboot for GRUB changes

# Backup and configure logind
sudo cp /etc/systemd/logind.conf /etc/systemd/logind.conf.backup

sudo tee /etc/systemd/logind.conf > /dev/null << 'EOF'
[Login]
HandleLidSwitch=ignore
HandleLidSwitchExternalPower=ignore
HandleLidSwitchDocked=ignore
IdleAction=ignore
EOF

# Configure bootloader for AMD deep sleep
if [ -f /etc/default/grub ]; then
    # GRUB bootloader
    sudo cp /etc/default/grub /etc/default/grub.backup

    # Add mem_sleep_default if not present
    if ! grep -q "mem_sleep_default" /etc/default/grub; then
        sudo sed -i 's/GRUB_CMDLINE_LINUX_DEFAULT="\(.*\)"/GRUB_CMDLINE_LINUX_DEFAULT="\1 mem_sleep_default=deep"/' /etc/default/grub
        sudo grub-mkconfig -o /boot/grub/grub.cfg
    fi
elif [ -d /boot/loader/entries ]; then
    # systemd-boot
    echo "systemd-boot detected. Adding mem_sleep_default=deep to boot entries..."
    for entry in /boot/loader/entries/*.conf; do
        if [ -f "$entry" ] && ! grep -q "mem_sleep_default" "$entry"; then
            sudo sed -i '/^options/ s/$/ mem_sleep_default=deep/' "$entry"
        fi
    done
else
    echo "Warning: Could not detect bootloader. Please manually add 'mem_sleep_default=deep' to kernel parameters."
fi

# Optimize USB power management (permanent)
# Only disable autosuspend for input devices and USB hubs
sudo tee /etc/udev/rules.d/90-usb-power-management.rules > /dev/null << 'EOF'
# Enable USB wake for all devices
ACTION=="add", SUBSYSTEM=="usb", ATTR{power/wakeup}="enabled"

# Disable autosuspend ONLY for HID devices (keyboards, mice)
# Interface Class 03 = Human Interface Device
ACTION=="add", SUBSYSTEM=="usb", ATTRS{bInterfaceClass}=="03", ATTR{power/autosuspend}="-1"
ACTION=="add", SUBSYSTEM=="usb", ATTRS{bInterfaceClass}=="03", ATTR{power/control}="on"

# Disable autosuspend for USB hubs (important for KVM switches)
# Device Class 09 = Hub
ACTION=="add", SUBSYSTEM=="usb", ATTR{bDeviceClass}=="09", ATTR{power/autosuspend}="-1"
ACTION=="add", SUBSYSTEM=="usb", ATTR{bDeviceClass}=="09", ATTR{power/control}="on"

# Optional: Increase autosuspend delay for other devices (default is 2 seconds)
# This allows brief inactivity without suspending
ACTION=="add", SUBSYSTEM=="usb", ATTR{power/autosuspend}="10"
EOF

# Apply USB power settings (immediate)
# Disable autosuspend for HID devices
for device in /sys/bus/usb/devices/*/power; do
    if [ -f "$device/autosuspend" ] && [ -f "${device%/power}/bInterfaceClass" ]; then
        class=$(cat "${device%/power}/bInterfaceClass" 2>/dev/null || echo "")
        if [ "$class" = "03" ]; then
            sudo sh -c "echo -1 > \"$device/autosuspend\"" 2>/dev/null
            sudo sh -c "echo on > \"$device/control\"" 2>/dev/null
        fi
    fi
done

# Disable autosuspend for USB hubs
for device in /sys/bus/usb/devices/*/power; do
    if [ -f "$device/autosuspend" ] && [ -f "${device%/power}/bDeviceClass" ]; then
        class=$(cat "${device%/power}/bDeviceClass" 2>/dev/null || echo "")
        if [ "$class" = "09" ]; then
            sudo sh -c "echo -1 > \"$device/autosuspend\"" 2>/dev/null
            sudo sh -c "echo on > \"$device/control\"" 2>/dev/null
        fi
    fi
done

# Enable wake for all USB devices
for device in /sys/bus/usb/devices/*/power/wakeup; do
    [ -f "$device" ] && sudo sh -c "echo enabled > \"$device\"" 2>/dev/null
done

# Apply changes
sudo udevadm control --reload-rules
sudo udevadm trigger

# Use gum for confirmation if available
if command -v gum >/dev/null 2>&1; then
    gum confirm "Lid-closed suspend configuration applied. Reboot now to apply changes?" && REBOOT=true || REBOOT=false
else
    read -p "Lid-closed suspend configuration applied. Your system will reboot now to apply changes. Press Enter to continue..."
    REBOOT=true
fi

if [ "$REBOOT" = true ]; then
    omarchy-cmd-reboot
fi